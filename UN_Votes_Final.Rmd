---
title: "United Nations Voting Analysis"
author: "Daniel Morgan"
date: "6 March 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

UN Voting Analysis

Data available here: https://github.com/dmorgan26/UN-Votes

Source: Erik Voeten "Data and Analyses of Voting in the UN General Assembly" Routledge Handbook of International
Organization, edited by Bob Reinalda (published 2017-06-19)


```{r}
library(readr)

unvotes <- read_csv("C:\\Users\\Dan\\Desktop\\R\\Markdowns\\UN-Votes\\votes.csv", col_names=TRUE)

```

Variable Names

assembly_session - the annual session in which the vote was cast
rc_id - Roll Call ID, identifier for each piece of legislation on which the assembly voted
state_code - ID for each member state given by the Correlates of War project
vote - 1 = Yes, 2 = Abstain, 3 = No, 8 = Not Present, 9 = Not A Member 

```{r}
library(dplyr)
glimpse(unvotes)
```

Data Cleaning

Removing absences and replacing assembly_session with year. First assembly vote in the data set was in 1946.
.
```{r}
votes_processed <- unvotes %>%
                      filter(vote <= 3) %>%
                      mutate(year = assembly_session + 1945)

votes_processed <- votes_processed[,-1]

glimpse(votes_processed)
```

Replacing state_code with country name

```{r}
library(countrycode)
votes_processed <- votes_processed %>%
                      mutate(country = countrycode(state_code, "cown", "country.name"))
```

The data gives state_code as Correlates of War codes

260 = German Federal Republic (commonly known as West Germany). 
816 = Republic of Vietnam (commonly known as South Vietnam). 

Other relevant codes

255 = Germany
265 = East Germany

817 = Vietnam

```{r}
code_260 <- votes_processed %>%
    filter(state_code == "260")

range(code_260$year)
```

Data shows West German votes from 1973-1989

```{r}
code_265 <- votes_processed %>%
    filter(state_code == "265")

range(code_265$year)
```

Data shows East German votes from 1973-1989

```{r}
code_255 <- votes_processed %>%
              filter(state_code == "255") 

range(code_255$year)
```

Data shows (unified) German votes from 1990-2014

There isn't any overlap of the dates so I will manually assign state_code 260 to West Germany

```{r}
votes_processed$country[votes_processed$state_code == "260"] <- "West Germany"

```

```{r}
code_816 <- votes_processed %>%
    filter(state_code == "816")

range(code_816$year)
```

Data shows Vietnamese votes from 1977-2014
```{r}
code_817 <- votes_processed %>%
              filter(state_code == "817")

dim(code_817)
```

No data for South Vietnam so I will manually assign state_code 816 to Vietnam

```{r}
votes_processed$country[votes_processed$state_code == "816"] <- "Vietnam"

sum(is.na(votes_processed$country)) # all NAs removed

votes_processed <- votes_processed[,-2]

glimpse(votes_processed)
```

Modelling the "agreeableness" of countries at the UN

Total fraction of "Yes" votes


```{r}
percent_yes <- votes_processed %>%
    summarize (total = n(), percent_yes = mean(vote == 1))

percent_yes
```
79.9% of all votes on proposed resolutions were for "Yes"

Summarizing by Year to use later

```{r}
by_year <- votes_processed %>%
  group_by(year) %>%
    summarize(total = n(), percent_yes = mean(vote == 1))

```

Summarizing by Country

```{r}
by_country <- votes_processed %>%
  group_by(country) %>%
  summarize(total = n(), percent_yes = mean(vote == 1)) %>%
  arrange(percent_yes)

head(by_country)
```

Zanzibar only has 2 votes, so filtering out countries with less than 100 votes

```{r}
by_country <- by_country %>%
                        filter(total > 100)

dim(by_country)

```

Zanzibar is the only country that was removed

Agreeableness Over Time

```{r}

library(ggplot2)
library(ggthemes)

ggplot(by_year, aes(x=year, y=percent_yes)) + geom_line() + 
  scale_y_continuous(breaks = seq(0,1,0.05), labels=scales::percent) + 
  scale_x_discrete(limits = c(1946, seq(1950, 2010, 5), 2014)) +
  labs(title = "% Yes votes at the UN General Assembly by Year", y = "% Yes", x = "Year") +
  theme_fivethirtyeight()
```

Investiating the huge dip

```{r}
which.min(by_year$percent_yes)
by_year[17:21,]

```

The year 1964 shows the total percentage of yes votes as 1.7%. The numbers for 1963 and 1965 are as expected at 72.9% and 70.8% respectively, so I will assume that this is an error and so will remove the year 1964 from the data set.

```{r}
by_year <- by_year[-19,]

votes_processed <- votes_processed %>%
                      filter(year != "1964")

ggplot(by_year, aes(x=year, y=percent_yes)) + 
  geom_line() + 
  scale_y_continuous(breaks = seq(0,1,0.05), labels=scales::percent) + 
  scale_x_discrete(limits = c(1946, seq(1950, 2010, 5), 2014)) +
  labs(title = "% Yes votes at the UN General Assembly by Year", y = "% Yes", x = "Year") +
  theme_fivethirtyeight()

```

Visualising as a scatter plot with least squares regression line
```{r}

library(scales)

ggplot(by_year, aes(x=year, y=percent_yes)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  scale_x_discrete(limits = c(1946, seq(1950, 2010, 5), 2014)) +
  scale_y_continuous(limits = c(0.4, 1), breaks = seq(0.4, 1, 0.05), labels=scales::percent) +  
  labs(title = "Least Squares % Yes votes at the UN General Assembly by Year", y = "% Yes", x = "Year") +
  theme_fivethirtyeight()
```

Voting Trends by Country

```{r}
by_year_country <- votes_processed %>%
  group_by(year, country) %>%
  summarize(total = n(), percent_yes = mean(vote == 1))

```
UK Votes Over Time

```{r}
by_year_country %>%
  filter(country == "United Kingdom") %>%
     ggplot(aes(x=year, y=percent_yes)) + 
      geom_line(col="blue") +
      scale_x_discrete(limits = c(1946, seq(1950, 2010, 5), 2014)) +
      scale_y_continuous(limits = c(0.2, 0.7), breaks = seq(0.2, 0.7, 0.05), labels=scales::percent) + 
      labs(title = "UK % Yes Vote", y = "% Yes", x = "Year") +
  theme_fivethirtyeight()
 
```

Comparing Agreeableness of Countries

```{r}
countries_line <- c("United Kingdom","United States","India","China")

by_year_country %>%
    filter(country %in% countries_line) %>%
    ggplot(aes(x=year, y=percent_yes, col=country)) + geom_line() +
      scale_x_discrete(limits = c(1946, seq(1950, 2010, 5), 2014)) +
      scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1), labels=scales::percent) + 
      scale_color_discrete(name="Country") +
      labs(title = "Vote Yes % By Country", y = "% Yes", x = "Year") +
  theme_fivethirtyeight()
  
```

Comparing too many countries to maintain a de-cluttered line plot

```{r}
countries_facet <- c("United Kingdom","United States","India","China", "Japan", "France", "Italy", "Egypt","Turkey")

by_year_country %>%
  filter(country %in% countries_facet) %>%
  ggplot(aes(x=year, y=percent_yes)) + geom_line() + facet_wrap(~country) +
      scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2), labels=scales::percent) +
      labs(title = "Vote Yes % By Country", y = "% Yes", x = "Year") +
  theme_fivethirtyeight() +
  theme(strip.background = element_rect(fill="lightgrey"))
```

Modelling the trend of agreeableness for each country

```{r}

library(tidyr)
library(purrr)
library(broom)

by_year_country <- ungroup(by_year_country)

country_coefficients <- by_year_country %>%
                        nest(-country) %>%
                    mutate(model = map(data, ~ lm(percent_yes ~ year, data = .)), 
                           tidied = map(model, tidy)) %>%
                        unnest(tidied) %>%
                        filter(term == "year")
```

Obtaining adjusted p-values since we would expect some raw p-values to be < 0.05 by chance when we have 200 models

```{r}
signif_country_coefficients <- country_coefficients %>%
                                  mutate(p.adjusted = p.adjust(p.value)) %>%
                                  filter(p.adjusted < 0.05)


```

Which countries showed the largest change in agreeableness over time?

```{r}
signif_country_coefficients %>%
  select(country, estimate) %>%
  arrange(desc(estimate))
```

Tuvalu is the nation whose agreeableness increased the most over their membership. The rate of increase is far larger than any other country so warrants further investigation
```{r}

tuvalu <- by_year_country %>%
          filter(country == "Tuvalu")

max(tuvalu$year) - min(tuvalu$year)

```
Tuvalu has only had a voting record for 13 years. How many votes is that? 

```{r}
tuvalu %>%
    ungroup() %>%
    mutate(cumsum = cumsum(total)) %>%
    summarize(total_votes = max(cumsum))

```
Tuvalu has participated in 629 votes, how does this compare to other nations?

```{r}

summary(by_country$total)

```

Tuvalu is a clear outlier here in a data set with significant left skew. 

If data is normally distributed I can see whether Tuvalu falls within three standard deviations of the mean

Do the total number of votes cast by each nation follow a normal disribution?

```{r}
library(ggpubr)
ggqqplot(by_country$total, main = "Q-Q Plot of Total Votes Cast") +
  theme_fivethirtyeight() +
  theme(axis.title = element_text()) + ylab('Votes') + xlab('Theoretical Quantiles')
```

Shapiro-Wilk test 

H0 : The data are normally distributed
HA : The data are not normally distributed

```{r}
shapiro.test(by_country$total)
```

A p-value < 0.05 and near zero suggests that the we can reject the null hypothesis that the data are normally distributed. Visual inspection of the Q-Q plot also suggests that the distribution is not normal. 

560 votes seems like a large enough sample so I will keep Tuvalu in the data set.

Whose agreeableness declined the most over time?

```{r}
signif_country_coefficients %>%
  arrange(estimate)
```


Bosnia & Herzagovinas agreeableness declined the most

Investigating voting by issue

```{r}
resolutions <- read_csv("C:\\Users\\Dan\\Desktop\\R\\Markdowns\\UN-Votes\\resolutions.csv", col_names=TRUE)
```

Cleaning to join to votes_processed

Locating NAs in the data set

```{r}

nas <- vector(length = 15)

for (i in 1:15) {
  nas[i] <- sum(is.na(resolutions[,i]))
}

nas

```

The vast majority of the NA values are mostly in the 'amendment' column which is of no interest so I will omit all NA values

```{r}

resolutions <- na.omit(resolutions[,-c(4,6:9)])

resolutions_processed <- resolutions %>%
    mutate(year = assembly_session + 1945) %>%
    rename(rc_id = vote_id) %>%
    select(-assembly_session)

#Re-ordering columns to show the new 'Year' column first
resolutions_processed <- resolutions_processed[,c(10,1:9)]

votes_joined <- inner_join(votes_processed, resolutions_processed, by=c("rc_id","year"))

votes_joined_processed <- votes_joined %>%
                          rename(col = colonization, hr = human_rights, 
                          mid = israel_palestine, dis = disarmament, 
                          nuke = nuclear_weapons, eco = economic_development)
```

How did a member state voted on different topics?

```{r}
library(stringr)

plot_agreeableness_by_issue <- function(x, y) {
  
by_issue_output <- votes_joined_processed %>%
                    filter(country == x & y == 1) %>%
                    group_by(year) %>%
                    mutate(percent_yes = mean(vote == 1))
  
y <- deparse(substitute(y))

topics <- c("Colonisation", "Human Rights", "Israel Palestine", "Arms Control and Disarmament", "Nuclear Weapons", "Economic Development")

names(topics) <- c("col", "hr", "mid", "dis", "nuke", "eco")
   
  topiclabel <- str_sub(y, start = 24)
  label_output <- topics[topiclabel]
  

   ggplot(data = by_issue_output, aes(x = year, y = percent_yes)) + geom_line() +
          scale_y_continuous(labels = scales::percent) +
          labs(title = sprintf("Agreeableness of %s on the topic of %s", x, label_output)) +
          theme_fivethirtyeight() + theme(plot.title = element_text(size=12)) +
          scale_x_discrete(limits = c(1946, seq(1950, 2010, 5), 2014)) +
          theme(axis.title = element_text(), axis.title.x = element_text()) + ylab('%Yes') + xlab('Year')
  
  
}

```

How has the US voted over time on issues of Nuclear Weapons?

```{r}
plot_agreeableness_by_issue("United States", votes_joined_processed$nuke)

```

How has France voted over time on issues of Israel Palestine?

```{r}
plot_agreeableness_by_issue("France", votes_joined_processed$mid)
```

How did a given country vote on all issues?

```{r}
votes_gathered <- gather(votes_joined_processed, topic, has_topic, col:eco) %>%
                  filter(has_topic == 1)

votes_tidied <- votes_gathered %>%
  mutate(topic = recode(topic,
                        mid = "Palestinian Conflict",
                        nuke = "Nuclear Weapons and Nuclear Material",
                        dis = "Arms Control and Disarmament",
                        hr = "Human Rights",
                        col = "Colonialism",
                        eco = "Economic Development"))

by_country_year_topic <- votes_tidied %>%
                      group_by(country, year, topic) %>%
                        summarize(total = n(), percent_yes = mean(vote==1)) %>%
                        ungroup()
 
country_vote_all_topics <- function(x) {
  
  by_country_year_topic %>%
      filter(country == x) %>%
      ggplot(aes(x = year, y = percent_yes)) + geom_line() + facet_wrap(~ topic) +
      labs(title = sprintf("Agreeableness of %s On All Issues", x), x = "Year", y = "% Yes") +
      scale_y_continuous(label = scales::percent) +
      theme_fivethirtyeight() +
      theme(strip.background = element_rect(fill="lightgrey")) +
      theme(strip.text = element_text(size = 8))
   
  
}

country_vote_all_topics("Belgium")

```

```{r}
country_vote_all_topics("Nigeria")
```

How does the agreeableness of two countries compare over time on each topic?

```{r}
two_country_comparison <- function(x,y) {
  
  by_country_year_topic %>%
      filter(country == x | country == y) %>%
      ggplot(aes(x = year, y = percent_yes, color=country)) + geom_line() + facet_wrap(~ topic) +
      labs(title = paste(x,"vs", y, "Agreeableness On All Issues"), x = "Year", y = "% Yes") +
      scale_y_continuous(label = scales::percent) + 
      scale_color_discrete(name = NULL) +
      theme_fivethirtyeight() + 
      theme(strip.background = element_rect(fill="lightgrey")) +
      theme(strip.text = element_text(size = 8))
  
  
}

two_country_comparison("Japan","Australia")

```

Whose agreeableness has increased/decreased the most over time on each topic?


```{r}
country_topic_coefficients <- by_country_year_topic %>%
                              nest(-country, -topic) %>%
                              mutate(model = map(data, ~ lm(percent_yes ~ year, data = .)),
                                      tidied = map(model, tidy)) %>%
                                      unnest(tidied) %>%
                                      filter(term == "year") %>%
                                      mutate(p.adjusted = p.adjust(p.value)) %>%
                                      filter(p.adjusted < 0.05) %>%
                                      select(country, topic, estimate)

country_topic_coefficients %>% arrange(desc(estimate))

```
Uzbek attitudes to Economic Development and Tuvaluan attitudes to Human Rights have seen the largest conformist shift

```{r}
country_topic_coefficients %>% arrange(estimate)
```

Vanuatan attitudes to the Palestinian Conflict and Bosnian attitudes to Human Rights have shown the strongest non-conformist movements in voting patterns




















